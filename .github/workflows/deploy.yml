name: Deploy to cPanel

on:
  push:
    branches: [main]

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  EMAIL_USER: ${{ secrets.EMAIL_USER }}
  EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

concurrency:
  group: deploy-to-cpanel
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      frontend-hash: ${{ steps.hash.outputs.frontend }}
      backend-hash: ${{ steps.hash.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Compute changed tree hashes
        id: hash
        run: |
          if [ -d frontend ]; then
            frontend_hash=$(git rev-list --objects HEAD -- frontend | git hash-object --stdin 2>/dev/null || echo "")
            echo "frontend=$frontend_hash" >> $GITHUB_OUTPUT
          else
            echo "frontend=" >> $GITHUB_OUTPUT
          fi
          if [ -d backend ]; then
            backend_hash=$(git rev-list --objects HEAD -- backend | git hash-object --stdin 2>/dev/null || echo "")
          else
            backend_hash=""
          fi
          # Include utils dir changes so deploy triggers when utils/ changes
          if [ -d utils ]; then
            utils_hash=$(git rev-list --objects HEAD -- utils | git hash-object --stdin 2>/dev/null || echo "")
            backend_hash="${backend_hash}${utils_hash}"
          fi
          echo "backend=$backend_hash" >> $GITHUB_OUTPUT
      - name: Create frontend artifact
        if: steps.hash.outputs.frontend != ''
        run: |
          set -e
          cd frontend
          zip -r ../frontend-artifact.zip package.json package-lock.json public src .env.production || true
      - name: Create backend artifact
        if: steps.hash.outputs.backend != ''
        run: |
          set -e
          cd backend
          zip -r ../backend-artifact.zip server.js db.js routes models uploads package.json package-lock.json || true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-artifacts
          path: |
            frontend-artifact.zip
            backend-artifact.zip

  frontend:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deploy-artifacts
          path: .
      - name: Unpack frontend
        if: needs.prepare.outputs.frontend-hash != ''
        run: |
          unzip -o frontend-artifact.zip -d frontend || true
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "16.x"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install & Build Frontend
        run: |
          cd frontend
          cp .env.production .env
          npm ci --prefer-offline --no-audit --no-progress || exit 1
          npm run build --no-progress || exit 1
        env:
          CI: false
          NODE_OPTIONS: --max-old-space-size=4096
      - name: Deploy Frontend
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: star-siec.edu.vn
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: frontend/build/
          server-dir: /ix.star-siec.edu.vn/frontend/build/
          dangerous-clean-slate: false
          exclude: |
            **/*.map
            **/*.txt
            **/LICENSE            
            **/static/media/*.webp
            **/static/media/*.svg

          state-name: .ftp-deploy-sync-state-frontend.json
          log-level: minimal
          timeout: 1200000
          dry-run: false

  backend:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deploy-artifacts
          path: .
      - name: Unpack backend
        if: needs.prepare.outputs.backend-hash != ''
        run: |
          unzip -o backend-artifact.zip -d backend-temp || true
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "16.x"
      - name: Prepare backend package
        if: needs.prepare.outputs.backend-hash != ''
        run: |
          set -e
          # Copy .env.production tá»« repo vÃ o backend-temp
          if [ -f "backend/.env.production" ]; then
            cp backend/.env.production backend-temp/.env
            echo "âœ… Using .env.production for cPanel"
          else
            echo "âš ï¸ .env.production not found, creating default .env"
            echo "NODE_ENV=production" > backend-temp/.env
            echo "PORT=5000" >> backend-temp/.env
            echo "DB_HOST=star-siec.edu.vn" >> backend-temp/.env
            echo "DB_NAME=wsxcblqh_ix" >> backend-temp/.env
            echo "DB_USER=wsxcblqh_thanh" >> backend-temp/.env
            echo "DB_PASS=@Thanh562184" >> backend-temp/.env
            echo "EMAIL_USER=stareduelt@gmail.com" >> backend-temp/.env
            echo "EMAIL_PASS=xrrz fqwq xwdc hujb" >> backend-temp/.env
            echo "EMAIL_TO=thanhlh@siec-star.edu.vn" >> backend-temp/.env
            echo "REACT_APP_API_URL=https://ix.star-siec.edu.vn" >> backend-temp/.env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> backend-temp/.env
          fi

          # Copy utils/ (if present at repo root) into package so modules like readingScorer are deployed
          if [ -d "utils" ]; then
            cp -r utils backend-temp/utils
            echo "âœ… Copied utils into backend-temp"
          fi

          # Also copy backend/utils into package (some projects keep helpers inside backend/)
          if [ -d "backend/utils" ]; then
            cp -r backend/utils backend-temp/utils
            echo "âœ… Copied backend/utils into backend-temp"
          fi

          ls -la backend-temp || true
      - name: Deploy Backend
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: star-siec.edu.vn
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: backend-temp/
          server-dir: /ix.star-siec.edu.vn/backend/
          dangerous-clean-slate: false
          exclude: |
            **/node_modules/**
            **/*.map
            **/*.md
            package-lock.json
          state-name: .ftp-deploy-sync-state-backend.json
          log-level: minimal
          timeout: 600000
      - name: Notify Manual Restart
        run: |
          echo "âœ… Backend Ä‘Ã£ Ä‘Æ°á»£c deploy lÃªn cPanel."
          echo "ğŸ“Œ Vui lÃ²ng Ä‘Äƒng nháº­p vÃ o cPanel â†’ Setup Node.js App â†’ chá»n app â†’ nháº¥n Restart Ä‘á»ƒ khá»Ÿi Ä‘á»™ng láº¡i server."

      - name: Post-deploy smoke check (non-blocking)
        run: |
          echo "â±ï¸ Running post-deploy smoke check (non-blocking) against /api/reading-tests"
          set +e
          status=$(curl -s -o /dev/null -w "%{http_code}" https://ix.star-siec.edu.vn/api/reading-tests || echo "000")
          echo "Smoke check HTTP status: $status"
          if [ "$status" = "200" ]; then
            echo "âœ… Smoke check OK"
          else
            echo "âš ï¸ Smoke check returned $status. If you just restarted the app, wait a few seconds and re-run checks."
          fi
          set -e
