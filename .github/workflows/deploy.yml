name: Deploy to cPanel
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16.x'

    # Build Frontend
    - name: Install & Build Frontend
      run: |
        cd frontend
        echo "REACT_APP_API_URL=https://ix.star-siec.edu.vn/api" > .env
        npm install
        npm run build
      env:
        CI: false

    # Deploy Frontend
    - name: Deploy Frontend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: frontend/build/
        server-dir: /ix.star-siec.edu.vn/frontend/build/
        dangerous-clean-slate: true

    # Prepare and Deploy Backend in steps
    - name: Create Backend Package
      run: |
        # Create temp directory
        mkdir -p backend-temp
        
        # Copy essential files only
        echo '{
          "name": "backend",
          "version": "1.0.0",
          "dependencies": {
            "express": "^4.18.2",
            "mysql2": "^3.6.1",
            "sequelize": "^6.33.0",
            "cors": "^2.8.5",
            "dotenv": "^16.3.1"
          }
        }' > backend-temp/package.json
        
        # Copy core backend files
        cp backend/server.js backend-temp/
        mkdir -p backend-temp/routes backend-temp/models backend-temp/uploads
        cp -r backend/routes/* backend-temp/routes/
        cp -r backend/models/* backend-temp/models/
        cp -r backend/uploads/* backend-temp/uploads/ || true
        
        # Create env file
        echo "NODE_ENV=production" > backend-temp/.env
        echo "PORT=3000" >> backend-temp/.env
        echo "DB_HOST=localhost" >> backend-temp/.env
        echo "DB_NAME=wsxcblqh_ix" >> backend-temp/.env
        echo "DB_USER=wsxcblqh_thanh" >> backend-temp/.env
        echo "DB_PASS=@Thanh562184" >> backend-temp/.env
        
        # Install minimal dependencies
        cd backend-temp
        npm install --production --no-optional

    # Deploy Backend (Minimal Version)
    - name: Deploy Backend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: backend-temp/
        server-dir: /ix.star-siec.edu.vn/backend/
        dangerous-clean-slate: true
        exclude: |
          **/node_modules/@*/**
          **/*.map
          **/*.md
          package-lock.json

    # Simple Server Restart
    - name: Restart Server
      run: |
        echo "<?php
        shell_exec('cd /home/wsxcblqh/ix.star-siec.edu.vn/backend && /usr/local/bin/npm install --production');
        shell_exec('/usr/local/bin/pm2 delete server 2>/dev/null || true');
        shell_exec('/usr/local/bin/pm2 start server.js');
        echo 'Server restarted';
        ?>" > restart.php
        
        # Upload and execute restart script directly
        curl -T restart.php -u "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" "ftp://star-siec.edu.vn/ix.star-siec.edu.vn/"
        curl "https://ix.star-siec.edu.vn/restart.php"
        rm restart.php