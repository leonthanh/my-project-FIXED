name: Deploy to cPanel
on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.4'

    # Cleanup remote directories first
    - name: Cleanup remote directories
      run: |
        echo "<?php
        function deleteDirectory(\$dir) {
          if (!file_exists(\$dir)) return;
          if (!is_dir(\$dir)) return unlink(\$dir);
          foreach (scandir(\$dir) as \$item) {
            if (\$item == '.' || \$item == '..') continue;
            if (!deleteDirectory(\$dir . DIRECTORY_SEPARATOR . \$item)) return false;
          }
          return rmdir(\$dir);
        }
        deleteDirectory('/home/wsxcblqh/ix.star-siec.edu.vn/backend/node_modules');
        deleteDirectory('/home/wsxcblqh/ix.star-siec.edu.vn/frontend/build');
        echo 'Cleanup completed';
        ?>" > cleanup.php
        curl -T cleanup.php "ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@star-siec.edu.vn/ix.star-siec.edu.vn/"
        curl "https://ix.star-siec.edu.vn/cleanup.php"
        rm cleanup.php

    # Build Frontend
    - name: Install & Build Frontend
      run: |
        cd frontend
        echo "REACT_APP_API_URL=https://ix.star-siec.edu.vn/api" > .env
        npm install
        npm run build
      env:
        CI: false

    # Deploy Frontend
    - name: Deploy Frontend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: frontend/build/
        server-dir: /ix.star-siec.edu.vn/frontend/build/
        dangerous-clean-slate: false
        exclude: |
          **/*.map
          **/*.txt
          **/node_modules/**

    # Prepare Backend
    - name: Setup Backend
      run: |
        cd backend
        echo "NODE_ENV=production" > .env
        echo "PORT=3000" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_NAME=wsxcblqh_ix" >> .env
        echo "DB_USER=wsxcblqh_thanh" >> .env
        echo "DB_PASS=@Thanh562184" >> .env
        
        # Create temp directory for production files
        mkdir -p ../temp-backend
        cp -r routes models uploads server.js package.json .env ../temp-backend/
        cd ../temp-backend
        npm install --production --no-optional

    # Deploy Backend
    - name: Upload Backend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: temp-backend/
        server-dir: /ix.star-siec.edu.vn/backend/
        dangerous-clean-slate: false
        exclude: |
          **/.git*/**
          **/node_modules/**
          **/.env.*
          **/*.map
          **/tests/**

    # Restart Server
    - name: Restart Server
      run: |
        echo "<?php 
        \$output = shell_exec('cd /home/wsxcblqh/ix.star-siec.edu.vn/backend && /usr/local/bin/npm install --production && /usr/local/bin/pm2 restart server.js 2>&1');
        echo \$output;
        echo 'Server restarted';
        ?>" > restart.php
        curl -T restart.php "ftp://${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}@star-siec.edu.vn/ix.star-siec.edu.vn/"
        sleep 5
        curl "https://ix.star-siec.edu.vn/restart.php"
        rm restart.php