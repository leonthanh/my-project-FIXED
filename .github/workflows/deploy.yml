name: Deploy to cPanel
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'  # Match với version Node.js trên cPanel

    # Cache dependencies
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: |
          **/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    # Build Frontend
    - name: Install & Build Frontend
      run: |
        cd frontend
        # Tạo file env cho production
        echo "REACT_APP_API_URL=https://ix.star-siec.edu.vn/api" > .env
        npm install
        npm run build
        
    # Build Backend
    - name: Install Backend Dependencies
      run: |
        cd backend
        yarn install

    # Deploy Frontend - optimize upload
    - name: Deploy Frontend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: frontend/build/
        server-dir: /ix.star-siec.edu.vn/frontend/build/
        dangerous-clean-slate: true
        exclude: |
          **/*.map
          **/ckeditor5/**
          **/@ckeditor/translations/**
          **/static/media/*.map

    # Prepare and Deploy Backend
    - name: Prepare Backend
      run: |
        cd backend
        # Tạo file env cho production
        echo "NODE_ENV=production" > .env
        echo "PORT=3000" >> .env
        echo "DB_HOST=localhost" >> .env
        echo "DB_NAME=wsxcblqh_ix" >> .env
        echo "DB_USER=wsxcblqh_thanh" >> .env
        echo "DB_PASS=@Thanh562184" >> .env
        npm ci --production

    # Deploy Backend - chỉ deploy các file cần thiết
    - name: Deploy Backend
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./backend/
        server-dir: /ix.star-siec.edu.vn/backend/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env.development
          **/.env.local
          **/deploy/
          **/ckeditor5/**
          **/@ckeditor/**
          **/dist/translations/**
          **/*.map
          **/*.ts
          **/test/**
          **/tests/**
          **/.github/**
          **/.vscode/**

    # Create restart script
    - name: Create restart script
      run: |
        echo "<?php
        shell_exec('cd /home/wsxcblqh/ix.star-siec.edu.vn/backend && /usr/local/bin/pm2 restart server.js || /usr/local/bin/pm2 start server.js');
        echo 'Deployment completed!';
        ?>" > restart.php

    - name: Deploy restart script
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: star-siec.edu.vn
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /ix.star-siec.edu.vn/
        exclude: |
          **/*
          !restart.php
